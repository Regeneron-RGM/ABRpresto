# ABRpresto
ABR thresholds, fast, accurate, no human needed.
<br>An algorithm for generating ABR thresholds by cross-correlation of resampled subaverages

This is code to algorithmically threshold ABR data as described in Shaheen et al. 2024. The algorithm needs the single-trial data (responses to each presentation of the stimuli).
Thresholds are generated by:
1. Randomly splitting the trials into two groups, and calculating the median waveform for each group, followed by the normalized cross correlation between these median waveforms. 
2. This process is repeated 500 times to obtain a reshuffled cross-correlation distribution. 
3. The mean values of these distributions are computed for each level and fit with a sigmoid and a power law. The fit that provides the best mean squared error is then used, and threshold is defined as where that fit crossed a criterion (default 0.3).

## Installing
This code must be installed using `pip install`. To install a version for
in-place modification (e.g., development), use `pip install -e`.

Full installation steps: (if you are using conda environments, you can
create a new environment to install this code, otherwise you can just install
directly into your main Python environment):

	(if using conda environments) conda create -n ABRpresto python git
	(if using conda environments) conda activate ABRpresto
	(navigate to the folder containing ABRpresto)
     python -m pip install -e ./ABRpresto


## Usage

See [Example_fit_script.py](scripts%2FExample_fit_script.py) for an example fitting a single waveform stack.
The algorithm expects data to be passed as a pandas dataframe with `polarity` and  `level` as indexes. Extra indexes will be dropped (for example `t0` in the example datasets).
Column headers should be the time relative to stimulus onset in seconds.
The example data is stored as csv, see Example_fit_script.py for how it is loaded and preprocessed before passing to the algorithm.

The algorithm will output a dictionary of results and a figure, which are saved as json and png.

### Figure output

In the left column the figures show mean +/- SE of all trials in black, and median (or mean, depending on AVmode) for the two subsets. Waveforms are normalized (for each level all 3 lines are scaled by the peak-to-peak of the mean of all trials). The right hand side shows mean correlation coefficient vs stimulus level. Sigmoid and power law fits to this data are shown in green and purple. The threshold is shown by the pink dashed line.

### Command line usage

The algorithm can be run on the command line to process either a list of csv files, or a whole folder of csv files:

To process a single dataset:

	ABRpresto <path to dataset>

To process several datasets:

	ABRpresto <path to dataset 1> <path to dataset2> <etc>

To recursively scan and process all datasets in a folder:

	ABRpresto <path> -r

## Citation

If you use this algorithm in you research, please cite:
XXX

The curve fitting decision tree used in this algorithm was inspired by Suthakar et al. If you use this algorithm please 
 also cite their paper:
Suthakar, K. & Liberman, M. C. A simple algorithm for objective threshold determination of auditory brainstem responses.
  Hear. Res. 381, 107782 (2019).
 

## License

Please see [LICENSE](LICENSE)

